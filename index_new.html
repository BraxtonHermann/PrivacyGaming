<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1e1b4b" />
    <meta name="description" content="Privacy Social Gaming - Confidential multiplayer games using Zama FHE protocol" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <title>Privacy Social Gaming - Confidential Multiplayer Games</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0a19 0%, #1e1b4b 50%, #312e81 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid #4c1d95;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a855f7, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #a3a3a3;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: rgba(15, 10, 25, 0.8);
            border: 1px solid #4c1d95;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .btn {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(168, 85, 247, 0.3);
        }

        .btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .btn.secondary:hover {
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: rgba(15, 10, 25, 0.8);
            border: 1px solid #4c1d95;
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #4c1d95;
            border-radius: 8px;
            background: rgba(30, 27, 75, 0.8);
            color: #f8fafc;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .game-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-button {
            background: rgba(30, 27, 75, 0.8);
            border: 2px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .option-button:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .option-button.selected {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
        }

        .games-grid {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            gap: 1rem;
        }

        .game-item {
            background: rgba(30, 27, 75, 0.6);
            border: 1px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .game-item:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .game-item.playing {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
        }

        .game-item.playing:hover {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #a3a3a3;
        }

        .game-title {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .game-stake {
            font-weight: 600;
            color: #06b6d4;
            margin-top: 0.5rem;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #a3a3a3;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4c1d95;
            border-top: 2px solid #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #6ee7b7;
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .game-options {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        .difficulty-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .difficulty-easy {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .difficulty-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .difficulty-hard {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .difficulty-expert {
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Privacy Social Gaming</h1>
            <p>Confidential multiplayer gaming platform using Zama FHE protocol for private moves and secure gameplay</p>
        </header>

        <div class="wallet-section">
            <div class="wallet-status">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="walletStatus">Not Connected</span>
                </div>
                <button class="btn" id="connectWallet">Connect Wallet</button>
            </div>
            <div id="walletAddress" class="hidden">
                <p><strong>Address:</strong> <span id="userAddress"></span></p>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Create Game Room</h2>
                <form id="createGameForm">
                    <div class="form-group">
                        <label for="gameName">Game Room Name</label>
                        <input type="text" id="gameName" required placeholder="Enter game room name">
                    </div>

                    <div class="form-group">
                        <label for="gameType">Game Type</label>
                        <select id="gameType" required>
                            <option value="">Select game type</option>
                            <option value="poker">Privacy Poker</option>
                            <option value="blackjack">Secret Blackjack</option>
                            <option value="rps">Rock Paper Scissors</option>
                            <option value="battleship">Encrypted Battleship</option>
                            <option value="chess">Confidential Chess</option>
                            <option value="trivia">Private Trivia</option>
                            <option value="auction">Secret Auction</option>
                            <option value="voting">Anonymous Voting</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxPlayers">Max Players</label>
                        <select id="maxPlayers" required>
                            <option value="">Select max players</option>
                            <option value="2">2 Players</option>
                            <option value="4">4 Players</option>
                            <option value="6">6 Players</option>
                            <option value="8">8 Players</option>
                            <option value="10">10 Players</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">Difficulty Level</label>
                        <select id="difficulty" required>
                            <option value="">Select difficulty</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="gameStake">Entry Stake (ETH)</label>
                        <input type="number" id="gameStake" step="0.001" min="0" required placeholder="0.0">
                    </div>

                    <button type="submit" class="btn" id="createBtn">Create Game Room</button>
                </form>
            </div>

            <div class="card">
                <h2>Active Game Rooms</h2>
                <div id="gamesGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading game rooms...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="joinGameCard" style="display: none;">
            <h2>Join Game Room</h2>
            <div id="joinGameContent">
                <div class="form-group">
                    <label>Join Method</label>
                    <div class="game-options">
                        <div class="option-button" data-method="public">
                            <strong>Public Join</strong><br>
                            <small>Visible participation</small>
                        </div>
                        <div class="option-button" data-method="anonymous">
                            <strong>Anonymous</strong><br>
                            <small>FHE encrypted identity</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Privacy Level</label>
                    <div class="game-options">
                        <div class="option-button" data-privacy="standard">
                            <strong>Standard</strong><br>
                            <small>Basic encryption</small>
                        </div>
                        <div class="option-button" data-privacy="maximum">
                            <strong>Maximum</strong><br>
                            <small>Full FHE protection</small>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn" id="joinBtn">Join Game Room</button>
                <button type="button" class="btn" id="cancelJoinBtn" style="background: #64748b; margin-left: 1rem;">Cancel</button>
            </div>
        </div>

        <div id="alerts"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>

    <script>
        const CONTRACT_ADDRESS = '0xBeb1a83923072478B2Ec4451Fb9BEb9b354B25ca';
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "_name", "type": "string"},
                    {"internalType": "string", "name": "_gameType", "type": "string"},
                    {"internalType": "uint8", "name": "_maxPlayers", "type": "uint8"},
                    {"internalType": "string", "name": "_difficulty", "type": "string"},
                    {"internalType": "uint256", "name": "_stake", "type": "uint256"}
                ],
                "name": "createGameRoom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_gameId", "type": "uint256"},
                    {"internalType": "bool", "name": "_isAnonymous", "type": "bool"},
                    {"internalType": "bool", "name": "_maxPrivacy", "type": "bool"}
                ],
                "name": "joinGameRoom",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getActiveGames",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "uint256", "name": "gameId", "type": "uint256"},
                            {"internalType": "string", "name": "name", "type": "string"},
                            {"internalType": "string", "name": "gameType", "type": "string"},
                            {"internalType": "uint8", "name": "maxPlayers", "type": "uint8"},
                            {"internalType": "uint8", "name": "currentPlayers", "type": "uint8"},
                            {"internalType": "string", "name": "difficulty", "type": "string"},
                            {"internalType": "uint256", "name": "stake", "type": "uint256"},
                            {"internalType": "address", "name": "creator", "type": "address"},
                            {"internalType": "bool", "name": "isActive", "type": "bool"}
                        ],
                        "internalType": "struct PrivacyGaming.GameRoom[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let provider, signer, contract, userAddress;
        let selectedJoinMethod = null;
        let selectedPrivacy = null;
        let currentGameId = null;

        const connectWalletBtn = document.getElementById('connectWallet');
        const statusDot = document.getElementById('statusDot');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const userAddressSpan = document.getElementById('userAddress');
        const createGameForm = document.getElementById('createGameForm');
        const gamesGrid = document.getElementById('gamesGrid');
        const joinGameCard = document.getElementById('joinGameCard');
        const alertsContainer = document.getElementById('alerts');

        const presetGames = [
            {
                gameId: 1,
                name: "Shadow Poker Championship",
                gameType: "poker",
                maxPlayers: 6,
                currentPlayers: 3,
                difficulty: "expert",
                stake: ethers.parseEther("0.01"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 86400000
            },
            {
                gameId: 2,
                name: "Secret Blackjack Arena",
                gameType: "blackjack",
                maxPlayers: 4,
                currentPlayers: 2,
                difficulty: "medium",
                stake: ethers.parseEther("0.005"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 172800000
            },
            {
                gameId: 3,
                name: "Encrypted Battle Royale",
                gameType: "battleship",
                maxPlayers: 8,
                currentPlayers: 5,
                difficulty: "hard",
                stake: ethers.parseEther("0.008"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 259200000
            },
            {
                gameId: 4,
                name: "Anonymous Auction House",
                gameType: "auction",
                maxPlayers: 10,
                currentPlayers: 7,
                difficulty: "medium",
                stake: ethers.parseEther("0.003"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 345600000
            },
            {
                gameId: 5,
                name: "Confidential Chess Masters",
                gameType: "chess",
                maxPlayers: 2,
                currentPlayers: 1,
                difficulty: "expert",
                stake: ethers.parseEther("0.001"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 432000000
            },
            {
                gameId: 6,
                name: "Private Trivia Night",
                gameType: "trivia",
                maxPlayers: 8,
                currentPlayers: 4,
                difficulty: "easy",
                stake: ethers.parseEther("0.002"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 518400000
            },
            {
                gameId: 7,
                name: "Secret RPS Tournament",
                gameType: "rps",
                maxPlayers: 4,
                currentPlayers: 3,
                difficulty: "medium",
                stake: ethers.parseEther("0.004"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 604800000
            },
            {
                gameId: 8,
                name: "Hidden Voting Council",
                gameType: "voting",
                maxPlayers: 10,
                currentPlayers: 8,
                difficulty: "easy",
                stake: ethers.parseEther("0.001"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 691200000
            }
        ];

        async function init() {
            await loadGameRooms();

            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed');

                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showAlert('Please install MetaMask to use this application', 'error');
            }
        }

// Fixed loadGameRooms function
async function loadGameRooms() {
    try {
        if (contract && provider) {
            // Check if contract is actually deployed
            try {
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code !== '0x') {
                    console.log('Contract found, loading from blockchain...');
                    const activeGames = await contract.getActiveGames();
                    if (activeGames && activeGames[0] && activeGames[0].length > 0) {
                        console.log('Loaded', activeGames[0].length, 'games from blockchain');
                        // Convert the tuple array format to our expected format
                        const games = activeGames[0].map((gameId, index) => ({
                            gameId: Number(gameId),
                            name: activeGames[1][index],
                            gameType: activeGames[2][index],
                            maxPlayers: activeGames[3][index],
                            currentPlayers: activeGames[4][index],
                            difficulty: activeGames[5][index],
                            stake: activeGames[6][index],
                            creator: activeGames[7][index],
                            isActive: activeGames[8][index]
                        }));
                        displayGameRooms(games);
                        return;
                    }
                } else {
                    console.log('Contract not deployed, using preset games');
                    showAlert('Contract not deployed - using demo games for testing', 'error');
                }
            } catch (contractError) {
                console.log('Contract error:', contractError.message);
                showAlert('Contract call failed - using demo games', 'error');
            }
        }
        // Always fallback to preset games
        console.log('Using preset games');
        displayGameRooms(presetGames);
    } catch (error) {
        console.error('Error loading game rooms:', error);
        console.log('Falling back to preset games');
        showAlert('Unable to load games - using preset games', 'error');
        displayGameRooms(presetGames);
    }
}

// Fixed createGameRoom function
async function createGameRoom(name, gameType, maxPlayers, difficulty, stake) {
    try {
        if (!contract) {
            showAlert('Contract not available - this is a demo. Connect wallet and deploy contract for full functionality.', 'error');
            return;
        }

        // Check if contract exists
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if (code === '0x') {
            showAlert('Contract not deployed. Deploy the Privacy Gaming contract first.', 'error');
            return;
        }

        const stakeInWei = ethers.parseEther(stake.toString());

        const tx = await contract.createGameRoom(name, gameType, maxPlayers, difficulty, stakeInWei);
        showAlert('Transaction submitted. Creating game room...', 'success');

        const receipt = await tx.wait();
        showAlert('Game room created successfully!', 'success');

        document.getElementById('createGameForm').reset();

        setTimeout(async () => {
            await loadGameRooms();
        }, 2000);
    } catch (error) {
        console.error('Error creating game room:', error);
        let errorMsg = 'Failed to create game room: ';

        if (error.message.includes('user rejected')) {
            errorMsg += 'Transaction cancelled by user';
        } else if (error.message.includes('insufficient funds')) {
            errorMsg += 'Insufficient funds for transaction';
        } else if (error.message.includes('execution reverted')) {
            errorMsg += 'Contract execution failed. Check parameters.';
        } else {
            errorMsg += 'Contract not available. This is demo mode.';
        }

        showAlert(errorMsg, 'error');
    }
}

// Fixed joinGameRoom function
async function joinGameRoom() {
    try {
        if (!selectedJoinMethod || !selectedPrivacy) {
            throw new Error('Please select join method and privacy level');
        }
        if (!currentGameId) {
            throw new Error('No game room selected');
        }

        if (!contract) {
            showAlert('Contract not available - this is a demo. Deploy contract for real gameplay.', 'error');
            resetJoinForm();
            return;
        }

        // Check if contract exists
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if (code === '0x') {
            showAlert('Contract not deployed. This is demo mode only.', 'error');
            resetJoinForm();
            return;
        }

        const game = presetGames.find(g => g.gameId === currentGameId);
        if (!game) throw new Error('Game room not found');

        const isAnonymous = selectedJoinMethod === 'anonymous';
        const maxPrivacy = selectedPrivacy === 'maximum';

        console.log('Joining game room:', currentGameId);
        console.log('Stake:', ethers.formatEther(game.stake), 'ETH');
        console.log('Anonymous:', isAnonymous);
        console.log('Max privacy:', maxPrivacy);

        const tx = await contract.joinGameRoom(
            currentGameId,
            isAnonymous,
            maxPrivacy,
            { value: game.stake }
        );

        showAlert('Join transaction submitted. Entering game room...', 'success');
        console.log('Transaction hash:', tx.hash);

        await tx.wait();
        showAlert(`Successfully joined game room #${currentGameId}!${isAnonymous ? ' (Anonymous mode with FHE)' : ''}`, 'success');

        resetJoinForm();
        setTimeout(async () => {
            await loadGameRooms();
        }, 2000);

    } catch (error) {
        console.error('Error joining game room:', error);
        let errorMsg = 'Failed to join game room: ';

        if (error.message.includes('user rejected')) {
            errorMsg += 'Transaction cancelled by user';
        } else if (error.message.includes('insufficient funds')) {
            errorMsg += 'Insufficient funds for stake amount';
        } else if (error.message.includes('execution reverted')) {
            errorMsg += 'Game room may be full or inactive';
        } else if (error.message.includes('Please select')) {
            errorMsg += error.message;
        } else {
            errorMsg += 'Contract not available. This is demo mode.';
        }

        showAlert(errorMsg, 'error');
    }
}