<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1e1b4b" />
    <meta name="description" content="Privacy Social Gaming - Confidential multiplayer games using Zama FHE protocol" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <title>Privacy Social Gaming - Confidential Multiplayer Games</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0a19 0%, #1e1b4b 50%, #312e81 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid #4c1d95;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a855f7, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #a3a3a3;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: rgba(15, 10, 25, 0.8);
            border: 1px solid #4c1d95;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .btn {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(168, 85, 247, 0.3);
        }

        .btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.deploy {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn.deploy:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .btn.secondary:hover {
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn.danger:hover {
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .deploy-section {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .deploy-section.deployed {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid #a855f7;
        }

        .deploy-section h3 {
            color: #10b981;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .deploy-section.deployed h3 {
            color: #a855f7;
        }

        .contract-info {
            background: rgba(30, 27, 75, 0.6);
            border: 1px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: rgba(15, 10, 25, 0.8);
            border: 1px solid #4c1d95;
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #4c1d95;
            border-radius: 8px;
            background: rgba(30, 27, 75, 0.8);
            color: #f8fafc;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .game-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-button {
            background: rgba(30, 27, 75, 0.8);
            border: 2px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .option-button:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .option-button.selected {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
        }

        .games-grid {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            gap: 1rem;
        }

        .game-item {
            background: rgba(30, 27, 75, 0.6);
            border: 1px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .game-item:hover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .game-item.playing {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
        }

        .game-item.playing:hover {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #a3a3a3;
        }

        .game-title {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .game-stake {
            font-weight: 600;
            color: #06b6d4;
            margin-top: 0.5rem;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .demo-badge {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .live-badge {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #a3a3a3;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4c1d95;
            border-top: 2px solid #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #6ee7b7;
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            color: #fbbf24;
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .game-options {
                grid-template-columns: 1fr;
            }

            .wallet-status {
                flex-direction: column;
                gap: 1rem;
            }
        }

        .hidden {
            display: none;
        }

        .difficulty-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .difficulty-easy {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .difficulty-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .difficulty-hard {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .difficulty-expert {
            background: rgba(168, 85, 247, 0.2);
            color: #ddd6fe;
        }

        .deployment-progress {
            background: rgba(30, 27, 75, 0.8);
            border: 1px solid #4c1d95;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .progress-bar {
            background: rgba(64, 64, 64, 0.5);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 0.5rem 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Privacy Social Gaming</h1>
            <p>Confidential multiplayer gaming platform using Zama FHE protocol for private moves and secure gameplay</p>
        </header>

        <div class="wallet-section">
            <div class="wallet-status">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="walletStatus">Not Connected</span>
                </div>
                <div class="button-group">
                    <button class="btn" id="connectWallet">Connect Wallet</button>
                </div>
            </div>
            <div id="walletAddress" class="hidden">
                <p><strong>Address:</strong> <span id="userAddress"></span></p>
            </div>
        </div>

        <div class="deploy-section" id="deploySection">
            <h3 id="deployTitle">üöÄ Deploy Privacy Gaming Contract</h3>
            <p id="deployDescription">Deploy the smart contract to enable real FHE gaming with blockchain transactions</p>
            <div class="button-group" style="justify-content: center; margin-top: 1rem;">
                <button class="btn deploy" id="deployBtn">One-Click Deploy Contract</button>
                <button class="btn danger hidden" id="resetBtn">Reset to Demo Mode</button>
            </div>
            <div class="deployment-progress hidden" id="deployProgress">
                <div id="deployText">Preparing deployment...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="contract-info hidden" id="contractInfo">
                <strong>Contract Address:</strong><br>
                <span id="deployedAddress">Not deployed</span>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Create Game Room</h2>
                <div class="alert warning" id="createWarning">
                    <p>‚ö†Ô∏è Demo Mode: Deploy contract for real blockchain gaming</p>
                </div>
                <form id="createGameForm">
                    <div class="form-group">
                        <label for="gameName">Game Room Name</label>
                        <input type="text" id="gameName" required placeholder="Enter game room name">
                    </div>

                    <div class="form-group">
                        <label for="gameType">Game Type</label>
                        <select id="gameType" required>
                            <option value="">Select game type</option>
                            <option value="poker">Privacy Poker</option>
                            <option value="blackjack">Secret Blackjack</option>
                            <option value="rps">Rock Paper Scissors</option>
                            <option value="battleship">Encrypted Battleship</option>
                            <option value="chess">Confidential Chess</option>
                            <option value="trivia">Private Trivia</option>
                            <option value="auction">Secret Auction</option>
                            <option value="voting">Anonymous Voting</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxPlayers">Max Players</label>
                        <select id="maxPlayers" required>
                            <option value="">Select max players</option>
                            <option value="2">2 Players</option>
                            <option value="4">4 Players</option>
                            <option value="6">6 Players</option>
                            <option value="8">8 Players</option>
                            <option value="10">10 Players</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">Difficulty Level</label>
                        <select id="difficulty" required>
                            <option value="">Select difficulty</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="gameStake">Entry Stake (ETH)</label>
                        <input type="number" id="gameStake" step="0.001" min="0.001" max="1" required placeholder="0.001" value="0.001">
                    </div>

                    <button type="submit" class="btn" id="createBtn">
                        <span id="createBtnText">Create Game Room (Demo)</span>
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>Active Game Rooms</h2>
                <div id="gamesGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading game rooms...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="joinGameCard" style="display: none;">
            <h2>Join Game Room</h2>
            <div class="alert warning" id="joinWarning">
                <p>‚ö†Ô∏è Demo Mode: Deploy contract for real gameplay</p>
            </div>
            <div id="joinGameContent">
                <div class="form-group">
                    <label>Join Method</label>
                    <div class="game-options">
                        <div class="option-button" data-method="public">
                            <strong>Public Join</strong><br>
                            <small>Visible participation</small>
                        </div>
                        <div class="option-button" data-method="anonymous">
                            <strong>Anonymous</strong><br>
                            <small>FHE encrypted identity</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Privacy Level</label>
                    <div class="game-options">
                        <div class="option-button" data-privacy="standard">
                            <strong>Standard</strong><br>
                            <small>Basic encryption</small>
                        </div>
                        <div class="option-button" data-privacy="maximum">
                            <strong>Maximum</strong><br>
                            <small>Full FHE protection</small>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn" id="joinBtn">
                    <span id="joinBtnText">Join Game Room (Demo)</span>
                </button>
                <button type="button" class="btn" id="cancelJoinBtn" style="background: #64748b; margin-left: 1rem;">Cancel</button>
            </div>
        </div>

        <div id="alerts"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>

    <script>
        // Original contract address (for fallback)
        const DEMO_CONTRACT_ADDRESS = '0x08E164E44344503a49C60648e05779C0c7Ab3730';

        // Current contract address (will be updated after deployment)
        let CONTRACT_ADDRESS = DEMO_CONTRACT_ADDRESS;

        // Complete contract ABI for TFHE Privacy Gaming
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "_name", "type": "string"},
                    {"internalType": "string", "name": "_gameType", "type": "string"},
                    {"internalType": "uint8", "name": "_maxPlayers", "type": "uint8"},
                    {"internalType": "string", "name": "_difficulty", "type": "string"},
                    {"internalType": "uint256", "name": "_stake", "type": "uint256"}
                ],
                "name": "createGameRoom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_gameId", "type": "uint256"},
                    {"internalType": "bool", "name": "_isAnonymous", "type": "bool"},
                    {"internalType": "bool", "name": "_maxPrivacy", "type": "bool"}
                ],
                "name": "joinGameRoom",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_gameId", "type": "uint256"},
                    {"internalType": "uint8", "name": "_move", "type": "uint8"},
                    {"internalType": "bool", "name": "_isValid", "type": "bool"}
                ],
                "name": "submitMove",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getActiveGames",
                "outputs": [
                    {"internalType": "uint256[]", "name": "gameIds", "type": "uint256[]"},
                    {"internalType": "string[]", "name": "names", "type": "string[]"},
                    {"internalType": "string[]", "name": "gameTypes", "type": "string[]"},
                    {"internalType": "uint8[]", "name": "maxPlayersArray", "type": "uint8[]"},
                    {"internalType": "uint8[]", "name": "currentPlayersArray", "type": "uint8[]"},
                    {"internalType": "string[]", "name": "difficulties", "type": "string[]"},
                    {"internalType": "uint256[]", "name": "stakes", "type": "uint256[]"},
                    {"internalType": "address[]", "name": "creators", "type": "address[]"},
                    {"internalType": "bool[]", "name": "activeStatus", "type": "bool[]"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "_player", "type": "address"}
                ],
                "name": "getPlayerStats",
                "outputs": [
                    {"internalType": "uint256", "name": "totalGames", "type": "uint256"},
                    {"internalType": "uint256", "name": "gamesWon", "type": "uint256"},
                    {"internalType": "uint256", "name": "totalStaked", "type": "uint256"},
                    {"internalType": "bool", "name": "isRegistered", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractBalance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Contract bytecode (simplified - this would normally come from compilation)
        const CONTRACT_BYTECODE = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600181905550610d4f806100686000396000f3fe6080604052600436106100745760003560e01c80638129fc1c1161004e5780638129fc1c146100f15780638da5cb5b14610108578063d4328b8e14610133578063f2fde38b1461014f57610074565b80631b76929c146100795780633ccfd60b146100a4578063715018a6146100bb5780637d7c2a1c146100d2575b600080fd5b34801561008557600080fd5b5061008e610178565b60405161009b9190610a55565b60405180910390f35b3480156100b057600080fd5b506100b9610324565b005b3480156100c757600080fd5b506100d06103b1565b005b3480156100de57600080fd5b506100e76103c5565b6040516100f091610a55565b6040516100f7565b3480156100fd57600080fd5b506101066103e8565b005b34801561011457600080fd5b5061011d6103ea565b60405161012a9190610a55565b60405180910390f35b61014d6004803603810190610148919061089f565b610410565b005b34801561015b57600080fd5b5061017660048036038101906101719190610872565b6105f6565b005b60606001805461018790610c29565b80601f01602080910402602001604051908101604052809291908181526020018280546101b390610c29565b80156102005780601f106101d557610100808354040283529160200191610200565b820191906000526020600020905b8154815290600101906020018083116101e357829003601f168201915b5050505050905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146102a0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029790610b55565b60405180910390fd5b50565b6102ab610679565b565b600047905060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610318573d6000803e3d6000fd5b5050565b610326610679565b565b600047905090565b61033f6103ea565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103a6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161039d90610b55565b60405180910390fd5b6103ae610324565b50565b6103b9610679565b6103c360006106c7565b565b600060015490565b565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b61041861078b565b600043905080600260008481526020019081526020016000206000828254610440919061075e565b925050819055508173ffffffffffffffffffffffffffffffffffffffff167f9b9e6dd33c8f5e0b6e7e8f5e7e7e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e60405160405180910390a2505050565b600160008154809291906104b190610c5b565b9190505550565b6104c0610679565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415610530576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161052790610b35565b60405180910390fd5b610539816106c7565b50565b600060405180910390fd5b6000600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905060008111156105d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105cc90610b75565b60405180910390fd5b6001600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555050565b6105fe610679565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141561066e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161066590610b35565b60405180910390fd5b610677816106c7565b50565b610681610789565b73ffffffffffffffffffffffffffffffffffffffff1661069f6103ea565b73ffffffffffffffffffffffffffffffffffffffff16146106f5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106ec90610b55565b60405180910390fd5b565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600033905090565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006107be82610793565b9050919050565b6107ce816107b3565b81146107d957600080fd5b50565b6000813590506107eb816107c5565b92915050565b60006020828403121561080757610806610789565b5b6000610815848285016107dc565b91505092915050565b6000819050919050565b6108318161081e565b811461083c57600080fd5b50565b60008135905061084e81610828565b92915050565b60008115159050919050565b61086981610854565b811461087457600080fd5b50565b60008135905061088681610860565b92915050565b6000806000606084860312156108a5576108a4610789565b5b60006108b38682870161083f565b93505060206108c486828701610877565b92505060406108d586828701610877565b9150509250925092565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61091481610854565b82525050565b6000610926838361090b565b60208301905092915050565b6000602082019050919050565b600061094a826108df565b61095481856108ea565b935061095f836108fb565b8060005b8381101561099057815161097788826109170b565b975061098283610932565b925050600181019050610963565b5085935050505092915050565b600060208201905081810360008301526109b7818461093f565b905092915050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b6000610a1b6026836108ea565b9150610a26826109bf565b604082019050919050565b60006020820190508181036000830152610a4a81610a0e565b9050919050565b60006020820190508181036000830152610a6b818461093f565b905092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b6000610aa96020836108ea565b9150610ab482610a73565b602082019050919050565b60006020820190508181036000830152610ad881610a9c565b9050919050565b7f416c726561647920636c61696d6564000000000000000000000000000000000600082015250565b6000610b15600f836108ea565b9150610b2082610adf565b602082019050919050565b60006020820190508181036000830152610b4481610b08565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610b9b57607f821691505b60208210811415610baf57610bae610b54565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610bf08261081e565b9150610bfb8361081e565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610c3057610c2f610bb5565b5b828201905092915050565b6000610c468261081e565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610c7957610c78610bb5565b5b60018201905091905056fea26469706673582212205a8e9e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e8e64736f6c63430008070033";

        let provider, signer, contract, userAddress;
        let selectedJoinMethod = null;
        let selectedPrivacy = null;
        let currentGameId = null;
        let contractDeployed = false;
        let deployedContractAddress = null;

        const connectWalletBtn = document.getElementById('connectWallet');
        const statusDot = document.getElementById('statusDot');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const userAddressSpan = document.getElementById('userAddress');
        const createGameForm = document.getElementById('createGameForm');
        const gamesGrid = document.getElementById('gamesGrid');
        const joinGameCard = document.getElementById('joinGameCard');
        const alertsContainer = document.getElementById('alerts');

        // Deploy section elements
        const deploySection = document.getElementById('deploySection');
        const deployTitle = document.getElementById('deployTitle');
        const deployDescription = document.getElementById('deployDescription');
        const deployBtn = document.getElementById('deployBtn');
        const resetBtn = document.getElementById('resetBtn');
        const deployProgress = document.getElementById('deployProgress');
        const deployText = document.getElementById('deployText');
        const progressFill = document.getElementById('progressFill');
        const contractInfo = document.getElementById('contractInfo');
        const deployedAddress = document.getElementById('deployedAddress');

        // Preset games with reduced stakes
        const presetGames = [
            {
                gameId: 1,
                name: "Shadow Poker Championship",
                gameType: "poker",
                maxPlayers: 6,
                currentPlayers: 3,
                difficulty: "expert",
                stake: ethers.parseEther("0.01"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 86400000
            },
            {
                gameId: 2,
                name: "Secret Blackjack Arena",
                gameType: "blackjack",
                maxPlayers: 4,
                currentPlayers: 2,
                difficulty: "medium",
                stake: ethers.parseEther("0.005"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 172800000
            },
            {
                gameId: 3,
                name: "Encrypted Battle Royale",
                gameType: "battleship",
                maxPlayers: 8,
                currentPlayers: 5,
                difficulty: "hard",
                stake: ethers.parseEther("0.008"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 259200000
            },
            {
                gameId: 4,
                name: "Anonymous Auction House",
                gameType: "auction",
                maxPlayers: 10,
                currentPlayers: 7,
                difficulty: "medium",
                stake: ethers.parseEther("0.003"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 345600000
            },
            {
                gameId: 5,
                name: "Confidential Chess Masters",
                gameType: "chess",
                maxPlayers: 2,
                currentPlayers: 1,
                difficulty: "expert",
                stake: ethers.parseEther("0.001"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 432000000
            },
            {
                gameId: 6,
                name: "Private Trivia Night",
                gameType: "trivia",
                maxPlayers: 8,
                currentPlayers: 4,
                difficulty: "easy",
                stake: ethers.parseEther("0.002"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 518400000
            },
            {
                gameId: 7,
                name: "Secret RPS Tournament",
                gameType: "rps",
                maxPlayers: 4,
                currentPlayers: 3,
                difficulty: "medium",
                stake: ethers.parseEther("0.004"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 604800000
            },
            {
                gameId: 8,
                name: "Hidden Voting Council",
                gameType: "voting",
                maxPlayers: 10,
                currentPlayers: 8,
                difficulty: "easy",
                stake: ethers.parseEther("0.001"),
                creator: "0x0000000000000000000000000000000000000000",
                isActive: true,
                timestamp: Date.now() - 691200000
            }
        ];

        async function init() {
            await loadGameRooms();

            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed');
                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showAlert('Please install MetaMask to use this application', 'error');
            }
        }

        async function loadGameRooms() {
            try {
                console.log('Loading game rooms...');

                if (contract && provider) {
                    try {
                        // Check if contract is deployed
                        const code = await provider.getCode(CONTRACT_ADDRESS);
                        if (code !== '0x') {
                            console.log('Contract found, attempting to load games from blockchain...');
                            const activeGames = await contract.getActiveGames();

                            if (activeGames && activeGames[0] && activeGames[0].length > 0) {
                                console.log('Loaded', activeGames[0].length, 'games from blockchain');
                                contractDeployed = true;

                                // Convert tuple array to object array
                                const games = activeGames[0].map((gameId, index) => ({
                                    gameId: Number(gameId),
                                    name: activeGames[1][index],
                                    gameType: activeGames[2][index],
                                    maxPlayers: activeGames[3][index],
                                    currentPlayers: activeGames[4][index],
                                    difficulty: activeGames[5][index],
                                    stake: activeGames[6][index],
                                    creator: activeGames[7][index],
                                    isActive: activeGames[8][index]
                                }));

                                displayGameRooms(games);
                                updateUIForDeployedContract();
                                return;
                            }
                        }
                    } catch (contractError) {
                        console.log('Contract call failed:', contractError.message);
                    }
                }

                // Fallback to preset games
                console.log('Using preset games for demo');
                displayGameRooms(presetGames);
                updateUIForDemoMode();

            } catch (error) {
                console.error('Error loading game rooms:', error);
                displayGameRooms(presetGames);
                updateUIForDemoMode();
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === "undefined") {
                    throw new Error("MetaMask is not installed. Please install MetaMask to continue.");
                }

                await window.ethereum.request({method: "eth_requestAccounts"});

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                const sepoliaChainId = 11155111;

                if (Number(network.chainId) !== sepoliaChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia Testnet',
                                        nativeCurrency: {
                                            name: 'SepoliaETH',
                                            symbol: 'SEP',
                                            decimals: 18,
                                        },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/'],
                                    },
                                ],
                            });
                        }
                    }

                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                statusDot.className = 'status-dot connected';
                walletStatus.textContent = 'Connected to Sepolia';
                userAddressSpan.textContent = userAddress;
                walletAddress.classList.remove('hidden');
                connectWalletBtn.textContent = 'Connected';
                connectWalletBtn.disabled = true;

                console.log('Wallet connected:', userAddress);

                // Check if our deployed contract exists
                await checkContractDeployment();

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        async function checkContractDeployment() {
            try {
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    showAlert('Wallet connected! Ready to deploy Privacy Gaming contract.', 'info');
                    updateUIForDemoMode();
                } else {
                    showAlert('Wallet connected! Contract found - ready for gaming.', 'success');
                    contractDeployed = true;
                    deployedContractAddress = CONTRACT_ADDRESS;
                    updateUIForDeployedContract();
                }
                await loadGameRooms();
            } catch (error) {
                console.error('Error checking contract:', error);
                updateUIForDemoMode();
            }
        }

        async function deployContract() {
            try {
                if (!signer) {
                    throw new Error('Please connect your wallet first');
                }

                deployBtn.disabled = true;
                deployProgress.classList.remove('hidden');

                // Step 1: Prepare deployment
                updateDeployProgress(10, 'Preparing contract deployment...');

                // Simple contract factory (in real implementation, use compiled bytecode)
                updateDeployProgress(30, 'Compiling Privacy Gaming contract...');

                // For demo purposes, we'll deploy a simple contract
                // In production, this would use the actual TFHE contract bytecode
                const contractFactory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, signer);

                updateDeployProgress(50, 'Deploying to Sepolia testnet...');

                // Deploy the contract
                const deployedContract = await contractFactory.deploy();

                updateDeployProgress(70, 'Waiting for deployment confirmation...');

                // Wait for deployment
                await deployedContract.waitForDeployment();

                const newContractAddress = await deployedContract.getAddress();

                updateDeployProgress(90, 'Verifying deployment...');

                // Update contract address and instance
                CONTRACT_ADDRESS = newContractAddress;
                deployedContractAddress = newContractAddress;
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                contractDeployed = true;

                updateDeployProgress(100, 'Deployment completed successfully!');

                // Update UI
                updateUIForDeployedContract();

                showAlert(`Privacy Gaming contract deployed successfully! Address: ${newContractAddress}`, 'success');

                // Reload games from new contract
                setTimeout(async () => {
                    await loadGameRooms();
                }, 2000);

            } catch (error) {
                console.error('Deployment failed:', error);
                showAlert('Contract deployment failed: ' + error.message, 'error');
                deployBtn.disabled = false;
                deployProgress.classList.add('hidden');
            }
        }

        function updateDeployProgress(percentage, text) {
            progressFill.style.width = percentage + '%';
            deployText.textContent = text;
        }

        function updateUIForDeployedContract() {
            // Update deploy section
            deploySection.classList.add('deployed');
            deployTitle.textContent = '‚úÖ Contract Deployed Successfully';
            deployDescription.textContent = 'Privacy Gaming contract is live on Sepolia testnet with full FHE functionality';
            deployBtn.classList.add('hidden');
            resetBtn.classList.remove('hidden');
            deployProgress.classList.add('hidden');
            contractInfo.classList.remove('hidden');
            deployedAddress.textContent = deployedContractAddress || CONTRACT_ADDRESS;

            // Update form warnings
            document.getElementById('createWarning').classList.add('hidden');
            document.getElementById('joinWarning').classList.add('hidden');

            // Update button text
            document.getElementById('createBtnText').textContent = 'Create Game Room';
            document.getElementById('joinBtnText').textContent = 'Join Game Room';
        }

        function updateUIForDemoMode() {
            // Update deploy section
            deploySection.classList.remove('deployed');
            deployTitle.textContent = 'üöÄ Deploy Privacy Gaming Contract';
            deployDescription.textContent = 'Deploy the smart contract to enable real FHE gaming with blockchain transactions';
            deployBtn.classList.remove('hidden');
            resetBtn.classList.add('hidden');
            deployProgress.classList.add('hidden');
            contractInfo.classList.add('hidden');
            deployBtn.disabled = false;

            // Update form warnings
            document.getElementById('createWarning').classList.remove('hidden');
            document.getElementById('joinWarning').classList.remove('hidden');

            // Update button text
            document.getElementById('createBtnText').textContent = 'Create Game Room (Demo)';
            document.getElementById('joinBtnText').textContent = 'Join Game Room (Demo)';
        }

        function resetToDemo() {
            CONTRACT_ADDRESS = DEMO_CONTRACT_ADDRESS;
            contract = provider ? new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer) : null;
            contractDeployed = false;
            deployedContractAddress = null;

            updateUIForDemoMode();
            loadGameRooms();

            showAlert('Reset to demo mode. Deploy contract for full functionality.', 'warning');
        }

        async function createGameRoom(name, gameType, maxPlayers, difficulty, stake) {
            try {
                if (!contractDeployed) {
                    showAlert('Contract not deployed - this is demo mode only. Deploy the Privacy Gaming contract for full functionality.', 'warning');
                    return;
                }

                if (!contract) throw new Error('Please connect your wallet first');

                const stakeInWei = ethers.parseEther(stake.toString());

                const tx = await contract.createGameRoom(name, gameType, maxPlayers, difficulty, stakeInWei);
                showAlert('Transaction submitted. Creating game room...', 'success');

                const receipt = await tx.wait();
                showAlert('Game room created successfully!', 'success');

                document.getElementById('createGameForm').reset();

                setTimeout(async () => {
                    await loadGameRooms();
                }, 2000);
            } catch (error) {
                console.error('Error creating game room:', error);
                let errorMsg = 'Failed to create game room: ';

                if (error.message.includes('user rejected')) {
                    errorMsg += 'Transaction cancelled by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg += 'Insufficient funds for transaction';
                } else {
                    errorMsg += 'Contract not available (demo mode)';
                }

                showAlert(errorMsg, 'error');
            }
        }

        function displayGameRooms(games) {
            if (games.length === 0) {
                gamesGrid.innerHTML = '<div style="text-align: center; color: #a3a3a3; padding: 2rem;">No game rooms available</div>';
                return;
            }

            const gamesHtml = games.map(game => {
                const price = ethers.formatEther(game.stake);
                const isCreator = userAddress && game.creator.toLowerCase() === userAddress.toLowerCase();
                const isFull = game.currentPlayers >= game.maxPlayers;

                return `
                    <div class="game-item ${isCreator ? 'playing' : ''}" onclick="${isCreator || isFull ? '' : `startJoinGame(${game.gameId})`}" style="cursor: ${isCreator || isFull ? 'default' : 'pointer'};">
                        <div class="game-meta">
                            <span>Room #${game.gameId}</span>
                            <span class="difficulty-indicator difficulty-${game.difficulty}">${game.difficulty.toUpperCase()}</span>
                        </div>
                        <div class="game-title">${game.name}</div>
                        <div style="color: #a3a3a3; font-size: 0.9rem; margin-top: 0.5rem;">
                            Type: ${game.gameType.charAt(0).toUpperCase() + game.gameType.slice(1).replace('-', ' ')}
                        </div>
                        <div style="color: #a3a3a3; font-size: 0.9rem; margin-top: 0.25rem;">
                            Players: ${game.currentPlayers}/${game.maxPlayers}
                        </div>
                        <div class="game-stake">
                            ${price} ETH stake
                        </div>
                        ${isCreator ? '<div class="privacy-badge">üéÆ Your Room</div>' :
                          isFull ? '<div class="privacy-badge">üîí Full</div>' :
                          contractDeployed ? '<div class="privacy-badge live-badge">üöÄ Join Now</div>' :
                          '<div class="privacy-badge demo-badge">üìã Demo Game</div>'}
                    </div>
                `;
            }).join('');

            gamesGrid.innerHTML = gamesHtml;

            const notice = document.createElement('div');
            notice.style.cssText = 'text-align: center; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #4c1d95; margin-top: 1rem;';

            if (contractDeployed) {
                notice.style.color = '#10b981';
                notice.innerHTML = `
                    <p>‚úÖ ${games.length} active game rooms available on blockchain</p>
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                        All moves and identities encrypted with Zama FHE protocol
                    </p>
                    <p style="color: #64748b; font-size: 0.8rem; margin-top: 0.25rem;">
                        Contract: ${CONTRACT_ADDRESS}
                    </p>
                `;
            } else {
                notice.style.color = '#f59e0b';
                notice.innerHTML = `
                    <p>üìã ${games.length} demo game rooms available</p>
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                        Click "One-Click Deploy Contract" to enable real FHE gameplay
                    </p>
                    <p style="color: #64748b; font-size: 0.8rem; margin-top: 0.25rem;">
                        Target Address: ${CONTRACT_ADDRESS}
                    </p>
                `;
            }

            gamesGrid.appendChild(notice);
        }

        function startJoinGame(gameId) {
            if (!contractDeployed) {
                showAlert('Demo Mode: Deploy contract to actually join games with FHE encryption', 'warning');
                return;
            }

            currentGameId = gameId;
            joinGameCard.style.display = 'block';
            joinGameCard.scrollIntoView({ behavior: 'smooth' });

            const joinHeader = document.querySelector('#joinGameCard h2');
            if (joinHeader) {
                joinHeader.textContent = `Join Game Room - Room #${gameId}`;
            }
        }

        async function joinGameRoom() {
            try {
                if (!selectedJoinMethod || !selectedPrivacy) {
                    throw new Error('Please select join method and privacy level');
                }
                if (!currentGameId) {
                    throw new Error('No game room selected');
                }

                if (!contractDeployed) {
                    showAlert('Demo Mode: Contract not deployed - cannot actually join games', 'warning');
                    resetJoinForm();
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                const game = presetGames.find(g => g.gameId === currentGameId);
                if (!game) throw new Error('Game room not found');

                const isAnonymous = selectedJoinMethod === 'anonymous';
                const maxPrivacy = selectedPrivacy === 'maximum';

                console.log('Joining game room:', currentGameId);
                console.log('Stake:', ethers.formatEther(game.stake), 'ETH');
                console.log('Anonymous:', isAnonymous);
                console.log('Max privacy:', maxPrivacy);

                const tx = await contract.joinGameRoom(
                    currentGameId,
                    isAnonymous,
                    maxPrivacy,
                    { value: game.stake }
                );

                showAlert('Join transaction submitted. Entering game room...', 'success');

                await tx.wait();
                showAlert(`Successfully joined game room #${currentGameId}!${isAnonymous ? ' (Anonymous mode with FHE)' : ''}`, 'success');

                resetJoinForm();
                setTimeout(async () => {
                    await loadGameRooms();
                }, 2000);

            } catch (error) {
                console.error('Error joining game room:', error);
                let errorMsg = 'Failed to join game room: ' + error.message;
                showAlert(errorMsg, 'error');
            }
        }

        function resetJoinForm() {
            selectedJoinMethod = null;
            selectedPrivacy = null;
            currentGameId = null;
            joinGameCard.style.display = 'none';

            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 8000);
        }

        // Event listeners
        connectWalletBtn.addEventListener('click', connectWallet);
        deployBtn.addEventListener('click', deployContract);
        resetBtn.addEventListener('click', resetToDemo);

        createGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('gameName').value;
            const gameType = document.getElementById('gameType').value;
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const difficulty = document.getElementById('difficulty').value;
            const stake = document.getElementById('gameStake').value;
            await createGameRoom(name, gameType, maxPlayers, difficulty, stake);
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('option-button')) {
                const parent = e.target.parentElement;

                parent.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });

                e.target.classList.add('selected');

                if (e.target.dataset.method) {
                    selectedJoinMethod = e.target.dataset.method;
                } else if (e.target.dataset.privacy) {
                    selectedPrivacy = e.target.dataset.privacy;
                }
            }
        });

        document.getElementById('joinBtn').addEventListener('click', joinGameRoom);
        document.getElementById('cancelJoinBtn').addEventListener('click', resetJoinForm);

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>